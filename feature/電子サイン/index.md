# 電子サイン

## 資料

notion  

[電子サイン]  
https://www.notion.so/XXX-2297cc578ba5800eae1ed87e2c934d3e


[電子レシート]  
https://www.notion.so/2157cc578ba580519d85c24a7c27ec93


## 留意事項

#### "署名が必要な状態" とは ？

- 磁気  
  常に紙署名が必要。  
  実際の処理では MS 読込後に即 "署名要" セットされ、以降変化しない。

- 接触  
  CVM Result : TAG 9F54 の結果で判定。  
  先頭バイト bit1-5 が "03" "05" "1F" なら紙署名が必要。
  これはオンラインオーソリ前に取得可能。

- 非接触
  EMVL2ライブラリからとれる _emvL2Func.EmvGetCVM() の結果。
  OBTAIN_SIGNATURE が結果なら紙署名が必要。
  これはオンラインオーソリ前に取得可能。


#### 運用ルール

フロー上、決済手順の実行後にサイン入力となるので、もしサインがキャンセルされたら取消をクライアント側は実行する必要あり。
このとき、再度媒体をかざさなければいけない。ユーザがやる保証がない。

⇒ おそらく決済ステータスで "印字待ち待機" をわかるようにしたほうがいいかも。
なので、その方式で以降記載。
   エイジイ以外で印字待ち待機されると困ると思うので、リクエストにこの動作にするかのフラグをつける。

## 改修内容

### TerminalAPI 

#### 要件

- API指定で取引と紐づけられた画像データを新規APIで保存できること。
- 画像データごとにハッシュをとる。ハッシュ鍵は、画像データごとに払い出した個別のものを使用する。
- ~~この新規API は "クレジットの支払い" 取引限定で利用できる。交通系の取引などが指定されるとエラーとする。~~
- この新規API は 種類 "sign" が指定されているときは、"クレジットの支払い" 取引限定で利用できる。
- 既設の "取引情報取得" でサインの要不要を判断できるようにする。

```
メモ：電子レシートはお客様控えと加盟店控えでファイル単位を分ける必要がある。
```

#### やること

IF追加
- 取引関連画像保存API  
  - クライアントから指定する項目
    - ファイル.png   ※ 拡張子.png に限定する  
    - 画像の種類 "sign"      （将来 "receipt" を追加）

  - TerminalAPI が保存、サーバアップロードする項目
    - ファイル.png
    - ファイルのハッシュコード（計算する）
    - KMS用キー検索情報がいる

    ハッシュコードのアルゴリズムは？
    - HMAC-SHA256 
    - 秘密鍵は KMS から払い出し  


~~取引取得API（既設改修）~~  
~~サインが必要かどうかを判断できる情報をレスポンスに追加する~~  
~~どうやらクレジット処理内の setSignatureFlag() を呼び出しているところで判断がついている模様。これを DBに保存か。~~  


### サーバサイド

#### 要件

- MyFIPS のインフラ・サーバ群に機能を実装する
- 新規 s3 に取引IDから紐づけられたパスでデータを保存する。
  この s3 は電子レシートの保管にも使用する。
- **MyFIPS, FIGコンソールの WEB画面** からはサインやレシートは DL できない。   
  ※ 今回の開発スコープでは、という話。拡張により対応は可能とする。


#### やること
端末からコールできる公開IF追加
- 取引関連画像保存API 
  - クライアントから指定する項目
    - ファイル.png   ※ 拡張子.png に限定する  
    - 画像の種類 "sign", "user_receipt", "merchant_receipt" を追加 ※サーバはもうやっとく。
    - 